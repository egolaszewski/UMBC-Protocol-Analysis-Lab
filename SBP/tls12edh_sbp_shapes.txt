(comment "CPSA 4.4.2")
(comment "Extracted shapes")

(herald
  "Session Binding Protocol with TLS 1.2 Signed Ephemeral Diffie-Hellman (uses the modified server as implemented and tested in the paper and the cookie authentication model (ca.scm) which showed the cookie stealing attack)."
  (bound 12))

(comment "CPSA 4.4.2")

(comment "All input read from tls12edh_sbp.scm")

(comment "Strand count bounded at 12")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (cookie any mesg) (response httpdata) (request httpreq)
    (p password) (cr sr random32) (spk akey) (u s ca name)
    (pt pt-0 pval) (cookiestor locn) (y rndx) (x expt))
  (defstrand clienta 10 (cookie cookie) (any any) (response response)
    (request request) (p p) (cr cr) (sr sr) (spk spk) (u u) (s s)
    (ca ca) (cookiestor cookiestor) (y y) (x x))
  (non-orig (invk spk) (privk ca))
  (pen-non-orig p)
  (uniq-orig cr sr)
  (uniq-gen y)
  (absent (y x))
  (traces
    ((send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat pt any))
      (stor cookiestor (cat pt-0 "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))))
  (label 0)
  (unrealized (0 1) (0 3))
  (origs (pt-0 (0 7)) (cr (0 0)))
  (comment "Not closed under rules"))

(defskeleton ca
  (vars (any any-0 mesg) (cookie data) (response httpdata)
    (request httpreq) (p password) (cr sr random32) (ppk skey)
    (spk akey) (u s ca name) (pt pt-0 pt-1 pt-2 pval)
    (cookiestor authstor locn) (x y rndx))
  (defstrand clienta 10
    (cookie (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr))))
    (any any) (response response) (request request) (p p) (cr cr)
    (sr sr) (spk spk) (u u) (s s) (ca ca) (cookiestor cookiestor) (y y)
    (x x))
  (defstrand servera 10 (any any-0) (cookie cookie) (response response)
    (request request) (p p) (cr cr) (sr sr) (ppk ppk) (spk spk) (u u)
    (s s) (ca ca) (authstor authstor) (x x) (y y))
  (precedes ((0 0) (1 0)) ((0 2) (1 2)) ((0 4) (1 4)) ((0 8) (1 8))
    ((1 1) (0 1)) ((1 3) (0 3)) ((1 5) (0 5)) ((1 9) (0 9)))
  (non-orig ppk (invk spk) (privk ca))
  (pen-non-orig p)
  (uniq-orig cookie cr sr)
  (uniq-gen x y)
  (absent (y x))
  (facts (neq u s))
  (rule fact-servera-neq0 trRl_clienta-at-6 trRl_clienta-at-7
    trRl_servera-at-6 trRl_servera-at-7)
  (operation encryption-test (displaced 2 0 clienta 9)
    (enc (enc cookie (hash ppk (hash (exp (gen) (mul y-0 x)) cr sr)))
      request-0
      (hash (hash (exp (gen) (mul y-0 x)) cr sr) "client_write")) (1 8))
  (traces
    ((send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (recv
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load cookiestor (cat pt any))
      (stor cookiestor
        (cat pt-0 "client store" u s
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))))
      (send
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    ((recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor (cat pt-1 any-0))
      (stor authstor (cat pt-2 "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))))
  (label 35)
  (parent 0)
  (realized)
  (shape)
  (maps
    ((0)
      ((u u) (s s) (ca ca) (p p) (cr cr) (sr sr) (spk spk) (y y) (x x)
        (cookie
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr))))
        (any any) (cookiestor cookiestor) (request request)
        (response response))))
  (origs (pt-0 (0 7)) (cookie (1 5)) (pt-2 (1 7)) (cr (0 0))
    (sr (1 1))))

(comment "Nothing left to do")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (any mesg) (cookie data) (response httpdata) (request httpreq)
    (p password) (cr sr random32) (spk akey) (u s ca name)
    (pt pt-0 pval) (cookiestor locn) (y rndx) (x expt))
  (defstrand clienta 10 (cookie cookie) (any any) (response response)
    (request request) (p p) (cr cr) (sr sr) (spk spk) (u u) (s s)
    (ca ca) (cookiestor cookiestor) (y y) (x x))
  (deflistener cookie)
  (non-orig (invk spk) (privk ca))
  (pen-non-orig p)
  (uniq-orig cr sr)
  (uniq-gen y)
  (absent (y x))
  (traces
    ((send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat pt any))
      (stor cookiestor (cat pt-0 "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    ((recv cookie) (send cookie)))
  (label 65)
  (unrealized (0 1) (0 3))
  (origs (pt-0 (0 7)) (cr (0 0)))
  (comment "Not closed under rules"))

(comment "Nothing left to do")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (cookie mesg) (response httpdata) (request httpreq)
    (cr sr random32) (spk akey) (s ca u name) (pt pval)
    (cookiestor locn) (y rndx) (x expt))
  (defstrand clientr 7 (cookie cookie) (response response)
    (request request) (cr cr) (sr sr) (spk spk) (u u) (s s) (ca ca)
    (cookiestor cookiestor) (y y) (x x))
  (non-orig (invk spk) (privk ca))
  (uniq-orig cr sr)
  (uniq-gen y)
  (absent (y x))
  (traces
    ((send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat pt "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))))
  (label 92)
  (unrealized (0 1) (0 3))
  (origs (cr (0 0)))
  (comment "Not closed under rules"))

(comment "Nothing left to do")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (any mesg) (cookie data) (request httpreq) (p password)
    (cr sr random32) (ppk skey) (spk akey) (s ca u name) (pt pt-0 pval)
    (authstor locn) (x rndx) (y expt))
  (defstrand servera 9 (any any) (cookie cookie) (request request) (p p)
    (cr cr) (sr sr) (ppk ppk) (spk spk) (u u) (s s) (ca ca)
    (authstor authstor) (x x) (y y))
  (non-orig ppk (invk spk) (privk ca))
  (uniq-orig cookie sr)
  (uniq-gen x)
  (traces
    ((recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor (cat pt any))
      (stor authstor (cat pt-0 "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))))
  (label 153)
  (realized)
  (origs (pt-0 (0 7)) (sr (0 1)) (cookie (0 5)))
  (comment "Not closed under rules"))

(defskeleton ca
  (vars (any mesg) (cookie data) (request httpreq) (p password)
    (cr sr random32) (ppk skey) (spk akey) (s ca u name) (pt pt-0 pval)
    (authstor locn) (x rndx) (y expt))
  (defstrand servera 9 (any any) (cookie cookie) (request request) (p p)
    (cr cr) (sr sr) (ppk ppk) (spk spk) (u u) (s s) (ca ca)
    (authstor authstor) (x x) (y y))
  (non-orig ppk (invk spk) (privk ca))
  (uniq-orig cookie sr)
  (uniq-gen x)
  (facts (neq u s))
  (rule fact-servera-neq0 trRl_servera-at-6 trRl_servera-at-7)
  (traces
    ((recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor (cat pt any))
      (stor authstor (cat pt-0 "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))))
  (label 154)
  (parent 153)
  (realized)
  (shape)
  (maps
    ((0)
      ((s s) (ca ca) (cr cr) (sr sr) (cookie cookie) (spk spk) (u u)
        (x x) (y y) (p p) (ppk ppk) (any any) (authstor authstor)
        (request request))))
  (origs (pt-0 (0 7)) (sr (0 1)) (cookie (0 5))))

(comment "Nothing left to do")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (any mesg) (cookie data) (request httpreq) (p password)
    (cr sr random32) (ppk skey) (spk akey) (s ca u name) (pt pt-0 pval)
    (authstor locn) (x rndx) (y expt))
  (defstrand servera 9 (any any) (cookie cookie) (request request) (p p)
    (cr cr) (sr sr) (ppk ppk) (spk spk) (u u) (s s) (ca ca)
    (authstor authstor) (x x) (y y))
  (non-orig ppk (invk spk) (privk ca))
  (uniq-orig cookie cr sr)
  (uniq-gen x)
  (traces
    ((recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor (cat pt any))
      (stor authstor (cat pt-0 "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))))
  (label 155)
  (realized)
  (origs (pt-0 (0 7)) (sr (0 1)) (cookie (0 5)))
  (comment "Not closed under rules"))

(defskeleton ca
  (vars (any mesg) (cookie data) (request httpreq) (p password)
    (cr sr random32) (ppk skey) (spk akey) (s ca u name) (pt pt-0 pval)
    (authstor locn) (x rndx) (y expt))
  (defstrand servera 9 (any any) (cookie cookie) (request request) (p p)
    (cr cr) (sr sr) (ppk ppk) (spk spk) (u u) (s s) (ca ca)
    (authstor authstor) (x x) (y y))
  (non-orig ppk (invk spk) (privk ca))
  (uniq-orig cookie cr sr)
  (uniq-gen x)
  (facts (neq u s))
  (rule fact-servera-neq0 trRl_servera-at-6 trRl_servera-at-7)
  (traces
    ((recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor (cat pt any))
      (stor authstor (cat pt-0 "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))))
  (label 156)
  (parent 155)
  (realized)
  (shape)
  (maps
    ((0)
      ((s s) (ca ca) (cr cr) (sr sr) (cookie cookie) (spk spk) (u u)
        (x x) (y y) (p p) (ppk ppk) (any any) (authstor authstor)
        (request request))))
  (origs (pt-0 (0 7)) (sr (0 1)) (cookie (0 5))))

(comment "Nothing left to do")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (cookie data) (request httpreq) (cr sr random32) (ppk skey)
    (spk akey) (s ca u name) (pt pval) (authstor locn) (x rndx)
    (y expt))
  (defstrand serverr 6 (cookie cookie) (request request) (cr cr) (sr sr)
    (ppk ppk) (spk spk) (u u) (s s) (ca ca) (authstor authstor) (x x)
    (y y))
  (non-orig ppk (invk spk) (privk ca))
  (uniq-orig sr)
  (uniq-gen x)
  (traces
    ((recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat pt "server store" s u cookie))))
  (label 157)
  (unrealized (0 4))
  (origs (sr (0 1)))
  (comment "Not closed under rules"))

(comment "Nothing left to do")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (any mesg) (cookie data) (response httpdata) (request httpreq)
    (p password) (cr sr random32) (spk akey) (u s ca name)
    (pt pt-0 pval) (cookiestor locn) (y rndx) (x expt))
  (deflistener cookie)
  (defstrand clienta 10 (cookie cookie) (any any) (response response)
    (request request) (p p) (cr cr) (sr sr) (spk spk) (u u) (s s)
    (ca ca) (cookiestor cookiestor) (y y) (x x))
  (non-orig (invk spk) (privk ca))
  (pen-non-orig p)
  (uniq-orig cr sr)
  (uniq-gen y)
  (goals
    (forall
      ((cookie data) (p password) (cr sr random32) (spk akey)
        (u s ca name) (y rndx) (x expt) (z z-0 strd))
      (implies
        (and (p "clienta" z 10) (p "" z-0 2)
          (p "clienta" "cookie" z cookie) (p "clienta" "p" z p)
          (p "clienta" "cr" z cr) (p "clienta" "sr" z sr)
          (p "clienta" "spk" z spk) (p "clienta" "u" z u)
          (p "clienta" "s" z s) (p "clienta" "ca" z ca)
          (p "clienta" "y" z y) (p "clienta" "x" z x)
          (p "" "x" z-0 cookie) (non (invk spk)) (non (privk ca))
          (pnon p) (uniq sr) (ugen y) (uniq-at cr z 0)) (false))))
  (traces ((recv cookie) (send cookie))
    ((send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat pt any))
      (stor cookiestor (cat pt-0 "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))))
  (label 160)
  (unrealized (1 1) (1 3))
  (origs (pt-0 (1 7)) (cr (1 0)))
  (comment "Not closed under rules"))

(comment "Nothing left to do")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (any mesg) (cookie data) (response httpdata) (request httpreq)
    (p password) (cr sr random32) (ppk skey) (spk akey) (u s ca name)
    (pt pt-0 pval) (cookiestor locn) (y rndx) (x expt))
  (defstrand clienta 10
    (cookie (enc cookie (hash ppk (hash (exp (gen) (mul y x)) cr sr))))
    (any any) (response response) (request request) (p p) (cr cr)
    (sr sr) (spk spk) (u u) (s s) (ca ca) (cookiestor cookiestor) (y y)
    (x x))
  (non-orig ppk (invk spk) (privk ca))
  (uniq-orig cr sr)
  (uniq-gen y)
  (goals
    (forall
      ((cookie data) (cr sr random32) (spk akey) (u s ca name) (y rndx)
        (x expt) (ppk skey) (z strd))
      (implies
        (and (p "clienta" z 10)
          (p "clienta" "cookie" z
            (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr))))
          (p "clienta" "cr" z cr) (p "clienta" "sr" z sr)
          (p "clienta" "spk" z spk) (p "clienta" "u" z u)
          (p "clienta" "s" z s) (p "clienta" "ca" z ca)
          (p "clienta" "y" z y) (p "clienta" "x" z x) (non (invk spk))
          (non (privk ca)) (non ppk) (uniq sr) (ugen y)
          (uniq-at cr z 0))
        (exists ((z-0 strd))
          (and (p "servera" "cookie" z-0 cookie)
            (p "servera" "spk" z-0 spk) (p "servera" "u" z-0 u)
            (p "servera" "s" z-0 s) (p "servera" "ca" z-0 ca)
            (uniq-at cookie z-0 5) (fact neq u s))))))
  (traces
    ((send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul y x)) cr sr)))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat pt any))
      (stor cookiestor
        (cat pt-0 "client store" u s
          (enc cookie (hash ppk (hash (exp (gen) (mul y x)) cr sr)))))
      (send
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul y x)) cr sr)))
          request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))))
  (label 187)
  (unrealized (0 1) (0 3) (0 5))
  (origs (pt-0 (0 7)) (cr (0 0)))
  (comment "Not closed under rules"))

(defskeleton ca
  (vars (any any-0 mesg) (cookie data) (response httpdata)
    (request httpreq) (p password) (cr sr random32) (ppk skey)
    (spk akey) (u s ca name) (pt pt-0 pt-1 pt-2 pval)
    (cookiestor authstor locn) (x y rndx))
  (defstrand clienta 10
    (cookie (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr))))
    (any any) (response response) (request request) (p p) (cr cr)
    (sr sr) (spk spk) (u u) (s s) (ca ca) (cookiestor cookiestor) (y y)
    (x x))
  (defstrand servera 10 (any any-0) (cookie cookie) (response response)
    (request request) (p p) (cr cr) (sr sr) (ppk ppk) (spk spk) (u u)
    (s s) (ca ca) (authstor authstor) (x x) (y y))
  (precedes ((0 0) (1 0)) ((0 2) (1 2)) ((0 4) (1 4)) ((0 8) (1 8))
    ((1 1) (0 1)) ((1 3) (0 3)) ((1 5) (0 5)) ((1 9) (0 9)))
  (non-orig ppk (invk spk) (privk ca))
  (uniq-orig cookie cr sr)
  (uniq-gen x y)
  (absent (y x))
  (facts (neq u s))
  (rule fact-servera-neq0 trRl_clienta-at-6 trRl_clienta-at-7
    trRl_servera-at-6 trRl_servera-at-7)
  (operation encryption-test (displaced 2 0 clienta 9)
    (enc (enc cookie (hash ppk (hash (exp (gen) (mul y-0 x)) cr sr)))
      request-0
      (hash (hash (exp (gen) (mul y-0 x)) cr sr) "client_write")) (1 8))
  (traces
    ((send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (recv
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load cookiestor (cat pt any))
      (stor cookiestor
        (cat pt-0 "client store" u s
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))))
      (send
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    ((recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor (cat pt-1 any-0))
      (stor authstor (cat pt-2 "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))))
  (label 222)
  (parent 187)
  (realized)
  (shape)
  (satisfies yes)
  (maps
    ((0)
      ((cookie cookie) (cr cr) (sr sr) (spk spk) (u u) (s s) (ca ca)
        (y y) (x x) (ppk ppk) (p p) (any any) (cookiestor cookiestor)
        (request request) (response response))))
  (origs (pt-0 (0 7)) (cookie (1 5)) (pt-2 (1 7)) (sr (1 1))
    (cr (0 0))))

(comment "Nothing left to do")

(defprotocol ca basic
  (defrole clienta
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (p password) (cookie any mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (send
        (enc "login" u p
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc "login-successful" cookie
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor any)
      (stor cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x)))
  (defrole clientr
    (vars (u s ca name) (cr sr random32) (y rndx) (x expt) (spk akey)
      (cookie mesg) (cookiestor locn) (request httpreq)
      (response httpdata))
    (trace (send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor (cat "client store" u s cookie))
      (send
        (enc cookie request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write"))))
    (uniq-gen y)
    (absent (y x))
    (gen-st (cat "client store" u s cookie)))
  (defrole servera
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (p password) (cookie data) (ppk skey) (any mesg) (authstor locn)
      (request httpreq) (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc "login" u p
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc "login-successful"
          (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (load authstor any)
      (stor authstor (cat "server store" s u cookie))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-orig cookie)
    (uniq-gen x)
    (facts (neq u s)))
  (defrole serverr
    (vars (u s ca name) (cr sr random32) (x rndx) (y expt) (spk akey)
      (cookie data) (ppk skey) (authstor locn) (request httpreq)
      (response httpdata))
    (trace (recv cr)
      (send
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (recv
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul x y)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul x y)) cr sr) "client_write"))))
      (send
        (enc
          (hash (exp (gen) (mul x y)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul x y)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul x y)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write")))
      (recv
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr)))
          request
          (hash (hash (exp (gen) (mul x y)) cr sr) "client_write")))
      (load authstor (cat "server store" s u cookie))
      (send
        (enc response
          (hash (hash (exp (gen) (mul x y)) cr sr) "server_write"))))
    (non-orig ppk)
    (uniq-gen x)
    (facts (neq u s))
    (gen-st (cat "server store" s u cookie)))
  (defgenrule neqRl_indx
    (forall ((x indx)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_strd
    (forall ((x strd)) (implies (fact neq x x) (false))))
  (defgenrule neqRl_mesg
    (forall ((x mesg)) (implies (fact neq x x) (false))))
  (defgenrule scissorsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (leads-to z0 i0 z2 i2))
        (and (= z1 z2) (= i1 i2)))))
  (defgenrule cakeRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (leads-to z0 i0 z1 i1)
          (leads-to z0 i0 z2 i2) (prec z1 i1 z2 i2)) (false))))
  (defgenrule no-interruption
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (leads-to z0 i0 z2 i2) (trans z1 i1)
          (same-locn z0 i0 z1 i1) (prec z0 i0 z1 i1) (prec z1 i1 z2 i2))
        (false))))
  (defgenrule shearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (trans z2 i2)
          (leads-to z0 i0 z1 i1) (same-locn z0 i0 z2 i2)
          (prec z0 i0 z2 i2))
        (or (and (= z1 z2) (= i1 i2)) (prec z1 i1 z2 i2)))))
  (defgenrule invShearsRule
    (forall ((z0 z1 z2 strd) (i0 i1 i2 indx))
      (implies
        (and (trans z0 i0) (trans z1 i1) (same-locn z0 i0 z1 i1)
          (leads-to z1 i1 z2 i2) (prec z0 i0 z2 i2))
        (or (and (= z0 z1) (= i0 i1)) (prec z0 i0 z1 i1)))))
  (defgenrule fact-servera-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "servera" z (idx 5)) (p "servera" "s" z s)
          (p "servera" "u" z u)) (fact neq u s))))
  (defgenrule fact-serverr-neq0
    (forall ((z strd) (s u name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "s" z s)
          (p "serverr" "u" z u)) (fact neq u s))))
  (defgenrule trRl_clienta-at-7
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_clienta-at-6
    (forall ((z strd))
      (implies (p "clienta" z (idx 8)) (trans z (idx 6)))))
  (defgenrule trRl_servera-at-7
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 7)))))
  (defgenrule trRl_servera-at-6
    (forall ((z strd))
      (implies (p "servera" z (idx 8)) (trans z (idx 6)))))
  (defgenrule gen-st-clientr-0
    (forall ((z strd) (cookie mesg) (s u name))
      (implies
        (and (p "clientr" z (idx 5)) (p "clientr" "cookie" z cookie)
          (p "clientr" "s" z s) (p "clientr" "u" z u))
        (gen-st (cat "client store" u s cookie)))))
  (defgenrule gen-st-serverr-0
    (forall ((z strd) (cookie data) (u s name))
      (implies
        (and (p "serverr" z (idx 6)) (p "serverr" "cookie" z cookie)
          (p "serverr" "u" z u) (p "serverr" "s" z s))
        (gen-st (cat "server store" s u cookie)))))
  (lang (random32 atom) (password atom) (httpreq atom) (httpdata atom)))

(defskeleton ca
  (vars (cookie data) (response httpdata) (request httpreq)
    (cr sr random32) (ppk skey) (spk akey) (s ca u name) (pt pval)
    (cookiestor locn) (y rndx) (x expt))
  (defstrand clientr 7
    (cookie (enc cookie (hash ppk (hash (exp (gen) (mul y x)) cr sr))))
    (response response) (request request) (cr cr) (sr sr) (spk spk)
    (u u) (s s) (ca ca) (cookiestor cookiestor) (y y) (x x))
  (non-orig (invk spk) (privk ca))
  (uniq-orig cr sr)
  (uniq-gen y)
  (goals
    (forall
      ((cookie data) (cr sr random32) (spk akey) (s ca u name) (y rndx)
        (x expt) (ppk skey) (z strd))
      (implies
        (and (p "clientr" z 7)
          (p "clientr" "cookie" z
            (enc cookie (hash ppk (hash (exp (gen) (mul x y)) cr sr))))
          (p "clientr" "cr" z cr) (p "clientr" "sr" z sr)
          (p "clientr" "spk" z spk) (p "clientr" "u" z u)
          (p "clientr" "s" z s) (p "clientr" "ca" z ca)
          (p "clientr" "y" z y) (p "clientr" "x" z x) (non (invk spk))
          (non (privk ca)) (uniq sr) (ugen y) (uniq-at cr z 0))
        (exists ((z-0 strd))
          (and (p "servera" "cookie" z-0 cookie)
            (p "servera" "spk" z-0 spk) (p "servera" "u" z-0 u)
            (p "servera" "s" z-0 s) (p "servera" "ca" z-0 ca)
            (uniq-at cookie z-0 5) (fact neq u s))))))
  (traces
    ((send cr)
      (recv
        (cat sr (cat s spk (enc (hash s spk) (privk ca))) (exp (gen) x)
          (enc (hash cr sr (exp (gen) x)) (invk spk))))
      (send
        (cat (exp (gen) y)
          (enc
            (hash (exp (gen) (mul y x)) "client finished"
              (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                (cat (exp (gen) x)
                  (enc (hash cr sr (exp (gen) x)) (invk spk)))
                (exp (gen) y)))
            (hash (hash (exp (gen) (mul y x)) cr sr) "client_write"))))
      (recv
        (enc
          (hash (exp (gen) (mul y x)) "server finished"
            (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
              (cat (exp (gen) x)
                (enc (hash cr sr (exp (gen) x)) (invk spk)))
              (exp (gen) y)
              (enc
                (hash (exp (gen) (mul y x)) "client finished"
                  (hash cr sr (cat s spk (enc (hash s spk) (privk ca)))
                    (cat (exp (gen) x)
                      (enc (hash cr sr (exp (gen) x)) (invk spk)))
                    (exp (gen) y)))
                (hash (hash (exp (gen) (mul y x)) cr sr)
                  "client_write"))))
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))
      (load cookiestor
        (cat pt "client store" u s
          (enc cookie (hash ppk (hash (exp (gen) (mul y x)) cr sr)))))
      (send
        (enc (enc cookie (hash ppk (hash (exp (gen) (mul y x)) cr sr)))
          request
          (hash (hash (exp (gen) (mul y x)) cr sr) "client_write")))
      (recv
        (enc response
          (hash (hash (exp (gen) (mul y x)) cr sr) "server_write")))))
  (label 252)
  (unrealized (0 1) (0 3))
  (origs (cr (0 0)))
  (comment "Not closed under rules"))

(comment "Nothing left to do")
